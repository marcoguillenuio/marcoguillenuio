# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#jobs
jobs:
  say-hello:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/configuration-reference/#executor-job
    docker:
      - image: cimg/base:stable

    parameters:
      token:
        type: string
        default: ""
      team_id:
        type: string
        default: ""
      repo:
        type: string
        default: "${CIRCLE_PROJECT_REPONAME}"
      branch:
        type: string
        default: "${CIRCLE_BRANCH}"
      commit:
        type: string
        default: "${CIRCLE_SHA1}"
      vcs_url:
        type: string
        default: "${CIRCLE_REPOSITORY_URL}"
      image:
        type: string
        default: ""
      environment:
        type: string
        default: ""
      event_name:
        type: string
        default: ""
      event_action:
        type: string
        default: ""
      user:
        type: string
        default: "${CIRCLE_USERNAME}"
      origin:
        type: string
        default: "circleci-orb"
    # Add steps to the job
    # See: https://circleci.com/docs/configuration-reference/#steps
    steps:
      - checkout
      - run:
          name: "Get VCS"
          command: |            
            if [[ "$CIRCLE_REPOSITORY_URL" == *"github.com"* ]]; then
              VCS="github"
            elif [[ "$CIRCLE_REPOSITORY_URL" == *"bitbucket.org"* ]]; then
              VCS="bitbucket"
            else
              VCS="unknown"
            fi
            echo "VCS: $VCS"
            echo 'export VCS="$VCS"' >> "$BASH_ENV"
      - run:
          name: "Say hello"
          command: |
            curl --location --request POST "https://marcoguillenuio.free.beeceptor.com/" \
              --header "`echo 'Authorization: Bearer' <<parameters.token>>`"\
              --header 'Content-Type: application/json'\
              --data "{
                \"repo\":\"<<parameters.repo>>\",
                \"branch\":\"<<parameters.branch>>\",
                \"commit\":\"<<parameters.commit>>\",
                \"image\":\"<<parameters.image>>\",
                \"environment\":\"<<parameters.environment>>\",
                \"event_name\":\"<<parameters.event_name>>\",
                \"event_action\":\"<<parameters.event_action>>\",
                \"team_id\":\"<<parameters.team_id>>\",
                \"vcs_url\":\"$VCS\",
                \"meta\":{ \"user\":\"<<parameters.user>>\", \"origin\":\"<<parameters.origin>>\" }
              }"            

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  say-hello-workflow:
    jobs:
      - say-hello
